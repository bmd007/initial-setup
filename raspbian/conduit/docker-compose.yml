services:

  conduit-deprecated:
    image: ghcr.io/ssmirr/conduit/conduit:latest
    container_name: conduit-deprecated
    command: ["start", "-b", "1024", "-m", "15", "-v"]
    volumes:
      - conduit-data:/home/conduit-dep/data
    restart: unless-stopped
    environment:
      - TZ=UTC
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  conduit:
    image: ghcr.io/psiphon-inc/conduit/cli:latest
    container_name: conduit
    restart: unless-stopped
    ports:
      - "9090:9090"
    command:
      [
        "start",
        "--max-clients",
        "2",
        "--bandwidth",
        "1024",
        "--data-dir",
        "/home/conduit/data",
        "--metrics-addr",
        "0.0.0.0:9090",
        "-v"
      ]
    volumes:
      - conduit-data:/home/conduit/data
    environment:
      - TZ=UTC
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    networks:
      - monitoring

  netdata:
    image: netdata/netdata:latest
    container_name: netdata
    restart: unless-stopped
    # Expose to host/device for dashboard access
    ports:
      - "19999:19999"  # Host:Container - accessible from device/network
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    volumes:
      - netdata-config:/etc/netdata
      - netdata-lib:/var/lib/netdata
      - netdata-cache:/var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Netdata config: scrapes Conduit via internal network (http://conduit:9090)
      - ./netdata/go.d/prometheus.conf:/etc/netdata/go.d/prometheus.conf:ro
    environment:
      - TZ=UTC
      - NETDATA_CLAIM_TOKEN=
      - NETDATA_CLAIM_URL=
    # Internal Docker network - Netdata talks to Conduit via 'conduit:9090'
    networks:
      - monitoring
    depends_on:
      - conduit

volumes:
  conduit-data:
    driver: local
  netdata-config:
    driver: local
  netdata-lib:
    driver: local
  netdata-cache:
    driver: local

networks:
  monitoring:
    driver: bridge
