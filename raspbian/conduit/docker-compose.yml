services:
  conduit:
    image: ghcr.io/psiphon-inc/conduit/cli:latest
    container_name: conduit
    restart: unless-stopped
    # Expose to host/device for external access
    ports:
      - "9090:9090"  # Host:Container - accessible from device/network
    command:
      [
        "start",
        "--max-clients",
        "50",
        "--bandwidth",
        "1024",
        "--data-dir",
        "/home/conduit/data",
        "--metrics-addr",
        "0.0.0.0:9090",  # Listen on all interfaces (container-internal)
        "-v"
      ]
    volumes:
      - conduit-data:/home/conduit/data
    environment:
      - TZ=UTC
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    # Internal Docker network for service-to-service communication
    networks:
      - monitoring

  netdata:
    image: netdata/netdata:latest
    container_name: netdata
    restart: unless-stopped
    # Expose to host/device for dashboard access
    ports:
      - "19999:19999"  # Host:Container - accessible from device/network
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    volumes:
      - netdata-config:/etc/netdata
      - netdata-lib:/var/lib/netdata
      - netdata-cache:/var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Netdata config: scrapes Conduit via internal network (http://conduit:9090)
      - ./netdata/go.d/prometheus.conf:/etc/netdata/go.d/prometheus.conf:ro
    environment:
      - TZ=UTC
      - NETDATA_CLAIM_TOKEN=
      - NETDATA_CLAIM_URL=
    # Internal Docker network - Netdata talks to Conduit via 'conduit:9090'
    networks:
      - monitoring
    depends_on:
      - conduit

volumes:
  conduit-data:
    driver: local
  netdata-config:
    driver: local
  netdata-lib:
    driver: local
  netdata-cache:
    driver: local

networks:
  # Internal bridge network for container-to-container communication
  # Services communicate via service names (e.g., http://conduit:9090)
  # This traffic never leaves the Docker host
  monitoring:
    driver: bridge
